{% extends "layouts/base.html" %}


{% load custom_tags %}

{% block title %} Bill by Category {% endblock %}

<!-- Specific Page CSS goes HERE  -->
{% block stylesheets %}{% endblock stylesheets %}

{% block content %}

<style>
    /* Jquery validation */
    label {
        border: 0;
        margin-bottom: 3px;
        display: block;
        width: 100%;
    }

    /* Datatable => to float button right  */
    div.dt-buttons {
        position: relative;
        float: right;
        border-radius: 20px;
    }

    /* Datatable => rounded corner button  */
    button.dt-button {
        border-radius: 20px;
    }

    .permission-denied {
        color: red;
        display: flex;
        justify-content: center;
        font-size: 25px;
        font-weight: 500;
    }

    .nav-pills.flex-column .nav-link.active {
        color: white;
        font-weight: bold;
    }

    .my-circle {
        content: attr(data-letters);
        display: inline-block;font-size:
        1em;width: 2.5em;height: 2.5em;
        line-height: 2.5em;
        text-align: center;
        border-radius: 50%;
        vertical-align: middle;
        color: white;
    }


    .select2-container--default .select2-selection--multiple:before {
    content: ' ';
    display: block;
    position: absolute;
    border-color: #888 transparent transparent transparent;
    border-style: solid;
    border-width: 5px 4px 0 4px;
    height: 0;
    right: 6px;
    margin-left: -4px;
    margin-top: -2px;top: 50%;
    width: 0;cursor: pointer
}

.select2-container--open .select2-selection--multiple:before {
    content: ' ';
    display: block;
    position: absolute;
    border-color: transparent transparent #888 transparent;
    border-width: 0 4px 5px 4px;
    height: 0;
    right: 6px;
    margin-left: -4px;
    margin-top: -2px;top: 50%;
   }
    /* Jquery validation */
    label {
        border: 0;
        margin-bottom: 3px;
        display: block;
        width: 100%;
        
    }


     .select2-container--open .select2-selection--multiple:before {
    content: ' ';
    display: block;
    position: absolute;
    border-color: transparent transparent #888 transparent;
    border-width: 0 4px 5px 4px;
    height: 0;
    right: 6px;
    margin-left: -4px;
    margin-top: -2px;top: 50%;
    width: 0;cursor: pointer
}

span.select2-selection.select2-selection--single {
    height: 37px;
}

span#select2-customer_bill_category-container {
    color: #999;
}

span#select2-business_name-container {
    color: #999;
}

.select2-dropdown {
  z-index: 9001;
}

input[type=text]{
    background-color: white;
}
.nav-pills>li>.nav-link.active{
    background: #00569D;
}
.accordion .card .card-body{
        padding: 15px;
    }
    .accordion.accordion-secondary .card .card-header{
        color: #00569d;
    }
    .accordion .card {
        border-radius:0px!important;
        border:1px solid #d4d4d4;
        background:#fff!important;
        margin-bottom: 0px;
    }
    .accordion .card:first-of-type{
        border-bottom: 1px solid #d4d4d4;
    }
    .card-heading{
        margin-bottom: 27px;
        text-align: center;
        font-weight: bolder;
        margin-top: 30px;
        
    }
</style>
<div class="content">
    <div class="page-inner">
        <!-- <div class="page-header">
            <h4 class="page-title">Bill by Category</h4>
            <ul class="breadcrumbs">
                <li class="nav-home">
                    <a href="/customer-index/">
                        <i class="flaticon-home"></i>
                    </a>
                </li>
                <li class="separator">
                    <i class="flaticon-right-arrow"></i>
                </li>
                <li class="nav-item">
                    <a href="/bills-by-category/">Bill by Category</a>
                </li>
            </ul>
        </div> -->
        <div class="row">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <div class="d-flex align-items-center">
                            <h4 class="card-title">Categorywise Bills</h4>
                            <ul class="breadcrumbs">
                                <li class="nav-home">
                                    <a href="/">
                                        <i class="flaticon-home"></i>
                                    </a>
                                </li>
                                <li class="separator">
                                    <i class="flaticon-right-arrow"></i>
                                </li>
                                <li class="nav-item">
                                    <a>Bill Info</a>
                                </li>
                                <li class="separator">
                                    <i class="flaticon-right-arrow"></i>
                                </li>
                                <li class="nav-item">
                                    <a href="/my-bills/">Categorywise Bills</a>
                                </li>
                            </ul>
                            <!-- <div class="ml-auto">
                                <ul class="nav nav-pills" id="pills-tab" role="tablist">
                                  <li class="nav-item">
                                    <a class="nav-link active" id="pills-category-tab" data-toggle="pill" href="#pills-category" role="tab" aria-controls="pills-category" aria-selected="true">Category</a>
                                  </li>
                                  <li class="nav-item">
                                    <a class="nav-link" id="pills-merchant-tab" data-toggle="pill" href="#pills-merchant" role="tab" aria-controls="pills-merchant" aria-selected="false">Merchant</a>
                                  </li>
                                  <li class="nav-item">
                                    <a class="nav-link" id="pills-tag-tab" data-toggle="pill" href="#pills-tag" role="tab" aria-controls="pills-tag" aria-selected="false">Tags</a>
                                  </li>
                                </ul>
                            </div> -->
                        </div>
                    </div>
                    <div class="card-body">
                         <div class="row">
                            <div class="col-md-12 form-control">


                                <div class="tab-content" id="pills-tabContent">
                                    <div class="tab-pane fade show active" id="pills-category" role="tabpanel" aria-labelledby="pills-category-tab">

                                        <h3 class="card-heading">Category Bills</h3>
                                        {% for bill_categories in allocated_bill_categories %}
                                        <div class="accordion accordion-secondary">
                                        
                                            <div class="card">
                                                <div class="card-header collapsed" id="heading"
                                                    data-toggle="collapse" 
                                                    aria-expanded="false" aria-controls="collapseone"
                                                    role="button">
                                                    <!-- data-target="#{{ bill_categories.id }}" add this to above div to gain the functionality of toggling --> 
                                                    <table style="margin-left: 240px;">
                                                      <tr>
                                                        <td style="color: #00569d;font-weight: 900;width: 190px;">{{bill_categories.bill_category_name}}</td>
                                                        <td><div class="my-circle" style="background:{{bill_categories.color}};margin-left: 150px;">{{bill_categories.bill_count}}
                                                        </div></td>
                                                      </tr>
                                                    </table>
                                                     
                                                    <!-- <div class="span-mode" style="color: #00569d"></div> -->
                                                </div>

                                                <div id="{{ bill_categories.id }}" class="collapse"
                                                    aria-labelledby="heading" data-parent="#accordion"
                                                    role="button">
                                                    {% for bill in bill_categories.bills %}
                                                    <div class="card-body">
                                                        <div class="row">
                                                            <div class="col-md-2" style="text-align:right;">
                                                                <div class="my-circle" style="background:{{bill.color}};">{{bill.bill_category.bill_category_name|make_list|first}}
                                                                </div>
                                                            </div>
                                                            <div class="col-md-3">
                                                                <div class="row">
                                                                    <!-- <div class="col-md-12">{{ bill.bill_category.bill_category_name }}</div> -->
                                                                         {% if bill.business_name %}
                                                                    <div class="col-md-12"><b>{{ bill.business_name }}</b></div>
                                                                    {% else %}
                                                                    <div class="col-md-12" style="font-size: 15px;"><b>Other</b></div>
                                                                    {% endif %}
                                                                    <div class="col-md-12">{{ bill.bill_category.bill_category_name }}</div>
                                                                    <div class="col-md-12">{{ bill.bill_date|date:'d-m-Y' }}</div>
                                                                    <div class="col-md-12">Invoice No. {{bill.invoice_no}}</div>
                                                                    {% if bill.customer_added == True %}
                                                                    <div class="col-md-12" style="color: red;">Self Added Bill</div>
                                                                    {% endif %}
                                                                </div>
                                                            </div>
                                                            <div class="col-md-4 text-center justify-content-center align-self-center">
                                                                <span class="align-middle" style="font-size: 15px">
                                                                ₹ {{ bill.amount|floatformat:2 }}
                                                                </span>
                                                            </div>
                                                            <div class="col-md-3 text-center justify-content-center align-self-center">
                                                                <div class="row">
                                                                    <span>
                                                                        {% if bill.bill_file %}
                                                                            {% if bill.db_table == "SavePetrolPumpBill" %}
                                                                                <a style="padding: 0px" class="btn btn-link btn-primary" href="http://157.230.228.250/petrol-pump-bill/{{bill.bill_url}}/" target="_blank">
                                                                                    <i class="fa fa-eye" aria-hidden="true"></i>
                                                                                </a>
                                                                            {% elif bill.db_table == "SaveParkingLotBill" %}
                                                                                <a style="padding: 0px" class="btn btn-link btn-primary" href="http://157.230.228.250/parking-lot-bill/{{bill.bill_url}}/" target="_blank">
                                                                                    <i class="fa fa-eye" aria-hidden="true"></i>
                                                                                </a>
                                                                            {% elif bill.db_table == "CustomerBill" %}
                                                                                {% if bill.customer_added == True %}
                                                                                    <a style="padding: 0px" class="btn btn-link btn-primary" href="http://157.230.228.250/self-added-bill/{{bill.bill_url}}/" target="_blank">
                                                                                        <i class="fa fa-eye" aria-hidden="true"></i>
                                                                                    </a>
                                                                                {% elif bill.customer_added == False %}
                                                                                    <a style="padding: 0px" class="btn btn-link btn-primary" href="http://157.230.228.250/my-bill/{{bill.bill_url}}/" target="_blank">
                                                                                        <i class="fa fa-eye" aria-hidden="true"></i>
                                                                                    </a>
                                                                                {% endif %}
                                                                            {% endif %}
                                                                        {% endif %}
                                                                    </span>
                                                                    <span style="margin-left: 25px;">
                                                                        {% if bill.bill_file %}
                                       
                                                                            <button type="button" style="padding: 0px" title="Download Bill" data-toggle="tooltip"
                                                                                class="btn btn-link btn-primary" data-original-title="Download Bill">
                                                                                <a href="{{ bill.bill_file.url }}" download>
                                                                                    <i class="fa fa-download" aria-hidden="true"></i>
                                                                                </a>
                                                                            </button>

                                                                        {% endif %}
                                                                    </span>
                                                                    
                                                                </div>
                                                            </div>

                                                        </div>
                                                    </div>
                                                    {% endfor %}
                                                </div>
                                            </div>
                                        
                                        </div>
                                        {% endfor %}
                                    </div>


                                    
                                    
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>



<div class="modal fade" id="sendbilmodel" role="dialog">
    <div class="modal-dialog">
      <!-- Modal content-->
      <form method="POST" class="form" id="send_bill_form" autocomplete="off">
        {% csrf_token %}
        <div class="modal-content">
          <div class="modal-header">
            <h2 class="modal-title w-100 text-center">Send Bill</h2>
          </div>
          <div class="modal-body">
            <input type="hidden" id="send_bill_id" name="send_bill_id" value="" />
            <input type="hidden" id="send_bill_data_table" name="send_bill_data_table" value="" />
            
            <select class="form-control" id="send_bill_to_merchant" name="send_bill_to_merchant">
                <option value="">Select Business</option>
                {% for merchant in allocated_merchants %}
                {% if merchant.m_business_name %}
                <option value="{{merchant.id}}">{{merchant.m_business_name}}</option>
                
                {% endif %}
                {% endfor %}
            </select>
          </div>
          <div class="modal-footer">
            <input id="send_bill_form_submit" type="submit" class="btn btn-primary" value="Save">
            <button type="button" class="btn btn-primary" data-dismiss="modal">Close</button>
          </div>
        </div>
      </form>
    </div>
  </div>


<div class="modal fade" id="myEditModal" role="dialog">
    <div class="modal-dialog modal-lg">
        <!-- Modal content-->

        <form class="form-control" action="/edit-my-bills/" method="POST" id="addbilleditform" name="editform"
            autocomplete="off" enctype="multipart/form-data">
            {% csrf_token %}

            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title w-100 text-center">Edit Bill</h2>
                </div>

                <div class="modal-body">
                    <div class="row ">
                        <div class="col-md-12">
                            <div class="row"> 
                                <input type="hidden" name="edit_db_table" id="edit_db_table" value="">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label>Bill Amount<span style="color: red;"> *</span></label>
                                        <div class="input-group mb-6">
                                            <input type="number" class="form-control mobile" name="edit_amount"
                                            pattern="[0-9]+" id="edit_amount" placeholder="Bill Amount" value="" required min="1" />
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label>Select Category</label>
                                        <div class="input-group mb-6">
                                            <select name="edit_category"  id="edit_category"
                                                class="form-control mobile js-example-basic-single" style="width: 100%;">
                                                <option value="">Select Category</option>
                                                {% for object in bill_category|dictsort:"bill_category_name.lower"  %}
                                                <option value="{{object.id}}">
                                                    {{object.bill_category_name}}</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label>Select Store</label>
                                        <div class="input-group mb-6">
                                            <select name="edit_business" id="edit_business"
                                                class="form-control mobile js-example-basic-single" style="width: 100%;">
                                                <option value="">Select Store</option>
                                                    {% for object1 in business_names|dictsort:"m_business_name.lower" %}
                                                <option value="{{object1.id}}">
                                                    {{object1.m_business_name}}({{object1.m_area}})
                                                </option>
                                                {% endfor %}
                                            </select>

                                        </div>
                                        <div class="row">
                                            <div class="col-md-10" style="margin-top: 5px; color: #63b90b"><span>If your store is not listed here, please select checkbox and add store name.</span>
                                            </div>
                                            <div class="col-md-2" style="margin-top: 10px"><input class="form-control" type="checkbox" name="edit_business_check" value="1" onchange="valueChanged1()" id="edit_business_check">
                                            </div>
                                            <div class="input-group mb-6">
                                            <input type="text" name="edit_custom_business" id="edit_custom_business" class="form-control" placeholder="Add Business Name">
                                            </div>
                                        </div> 
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label>Select Bill Tags</label>
                                            <select class="js-example-basic-single" name="edit_bill_tags" id="edit_bill_tags" multiple="multiple" style="width: 300px;">
                                                {% for bill_tag in bill_tags|dictsort:"bill_tags_name.lower"  %}
                                                    <option value="{{ bill_tag.id }}">{{ bill_tag.bill_tags_name }}</option>
                                                {% endfor %}
                                            </select>
                                    </div>
                                </div>
                                <input type="hidden" name="edit_bill_tags_value" id="edit_bill_tags_value" value="">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label> Bill Date<span style="color: red;"> *</span></label>
                                        <div class="input-group mb-6">
                                            <input type="date" class="form-control mobile" name="edit_date"
                                                id="edit_date" required/>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label>Notes/Remarks</label>
                                            <input type="text" maxlength="30" class="form-control" name="edit_remarks" id="edit_remarks">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label>Bill File<span style="color: red;">*</span></label>
                                        <input type="hidden" name="bill_id" id="bill_id">
                                        <input type="hidden" name="editfile_available" id="editfile_available" value="">
                                        <div class="input-group mb-6">
                                            <input type="file" class="form-control mobile" name="editfile" id="editfile" placeholder="Bill File" value="" required/>
                                            <input type="text" name="selected_file" id="selected_file" disabled="disabled" style="font-size:14px;">
                                        </div>
                                        <!-- <span style="color: red;"></span> -->
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label>Invoice No.<span style="color: red;"> *</span></label>
                                        <div class="input-group mb-6">
                                            <input type="text" class="form-control mobile" name="edit_invoice_no"
                                            id="edit_invoice_no" placeholder="Invoice No." value="" maxlength="10" pattern="[a-zA-Z0-9]+" required />
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <input type="submit" class="btn btn-primary" value="Update" data-id="">
                                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </form>

    </div>
</div>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
<script src="http://ajax.aspnetcdn.com/ajax/jquery.validate/1.11.1/jquery.validate.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/limonte-sweetalert2/7.29.2/sweetalert2.all.js"></script>
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-beta.1/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-beta.1/dist/js/select2.min.js"></script>

<script>
    $('.senbill').on('click', function(e) {
    var id = $(this).data("bill_id");
    var db_table = $(this).data("db_record");
    
    $('#send_bill_id').val(id);
    $('#send_bill_data_table').val(db_table);
});


</script>

<script type="text/javascript">

// $(document).ready(function () {

//     $("#edit_category").on('change', function(){
//         $.ajax({
//             type: "POST",
//             url: "/get-merchant-business-by-category-id/"+$("#edit_category").val()+"/",
//             data: {
//                 csrfmiddlewaretoken: document.getElementsByName('csrfmiddlewaretoken')[0].value,
//             },
//             success: function(result){
//                 $("#edit_business").empty();
//                 $('#edit_business').append("<option value=''>Select Store</option>");
//                 $.each(result, function (key, value) {
//                     $('#edit_business').append("<option value='" + value.id + "'>" + value.business_name + "</option>");
//                     console.log(value.id);
//                 });
//             }
//         });
//     })
// })


    function valueChanged()
    {

        if($('#business_check').is(":checked")){
            $("#business_name").val('').trigger('change')
            $("#custom_business").show();
            $("#business_name").prop('disabled', true); 
        }
        else{
            $("#custom_business").hide();
            $("#business_name").prop('disabled', false);
        }
    }

    function valueChanged1()
    {

        if($('#edit_business_check').is(":checked")){
            $("#edit_business_name").val('').trigger('change')
            $("#edit_custom_business").show();
            $("#edit_business_name").prop('disabled', true); 
        }
        else{
            $("#edit_custom_business").hide();
            $("#edit_business_name").prop('disabled', false);
        }
    }
</script>
<script>

$(document).ready(function() {

    $("#custom_business").hide();

    // $('.js-example-basic-single').select2();

    $("#bill_tags").select2({
        placeholder:" Select Business Category",
        // closeOnSelect: false,
    })

    $("#edit_bill_tags").select2({
        placeholder:" Select Tags",
        tags: true,
        // closeOnSelect: false,
    })

    $("#edit_bill_tags").on('change', function()
    {
        var opts2 = [], opt2;
        var len = edit_bill_tags.options.length;
        for (var i = 0; i < len; i++) {
            opt2 = edit_bill_tags.options[i];
            if (opt2.selected) {
            opts2.push(opt2.value);
            }
        }
        // business_category = $("#business_category_id option:selected").val()
        $("#edit_bill_tags_value").val(opts2)
    })

    $("#bill_tags").on('change', function()
    {
        var opts1 = [],opt1;
        var len = bill_tags.options.length;
        for (var i = 0; i < len; i++) {
            opt1 = bill_tags.options[i];
            if (opt1.selected) {
            opts1.push(opt1.value);
            }
        }
        $("#bill_tags_value").val(opts1)
    })

}); 

    

    var editmodaldiv = $("#edit-modal-div");
    $(".editBtn").on("click", function () {
        var eid = $(this).data('id');
        var business_name = $(this).data('busi_name');
        var category = $(this).data('cust_category');
        var bill_amount = $(this).data('amount');
        var invoice_no = $(this).data('invoice-no');
        var date = $(this).data('date_bill');
        var file = $(this).data('bill_file');
        var bill_tags_list = JSON.parse("[" + $(this).data('bill_tags_list') + "]");
        // var bill_tags_list = $(this).data('bill_tags_list');
        // var bill_tags_list = $('#edit_bill_tags option:selected')
        //         .toArray().map(item => item.value);

        console.log(bill_tags_list);
        console.log('file',file)
        remarks = $(this).data('remarks');
        edit_custom_business = $(this).data('edit_custom_business')
        customer_added = $(this).data('customer_added');
        db_table = $(this).data('db_table');

        $('#bill_id').val(eid);

        if($(this).data('bill') != ""){
            $('#editfile_available').val(1);
        }

        if(business_name != ""){
            $("#edit_business option[value="+business_name+"]").prop("selected",true).trigger("change")
        }

        if(category != ""){
            $("#edit_category option[value="+category+"]").prop("selected",true).trigger("change")
        }

        // var data=[];
        // var $el=$("#edit_bill_tags");
        // $("#edit_bill_tags").find('option:selected').each(function(){
        //     data.push({value:$(this).val(),text:$(this).text()});
        // });
        // console.log(data)
        $("#edit_bill_tags").val('').trigger('change')

        if(bill_tags_list.length > 0){
            for(i = 0; i < bill_tags_list.length; i++){
                val = bill_tags_list[i]
                // alert(val);
                console.log(bill_tags_list[i])
                $("#edit_bill_tags option[value="+val+"]").prop("selected",true).trigger("change");
            }
        }

        $('#edit_custom_business').val(edit_custom_business);
        $('#edit_amount').val(bill_amount);
        $('#edit_date').val(date);
        $('#edit_remarks').val(remarks);
        $('#edit_db_table').val(db_table);
        $('#selected_file').val(file);
        $('#edit_invoice_no').val(invoice_no);


        if(customer_added == 'False'){
            $("#edit_business").attr('disabled', true);
            $("#edit_amount").attr('disabled', true);
            $("#edit_date").attr('disabled', true);
            $("#editfile").attr('disabled', true);
            $("#edit_business_check").attr('disabled', true);
            $("#edit_category").attr('disabled', true);
            $('#edit_invoice_no').attr('disabled', true);
        }
        else{
            $("#edit_business").attr('disabled', false);
            $("#edit_amount").attr('disabled', false);
            $("#edit_date").attr('disabled', false);
            $("#editfile").attr('disabled', false);
            $("#edit_business_check").attr('disabled', false);
            $("#edit_category").attr('disabled', false);
            $('#edit_invoice_no').attr('disabled', false);

        }

        if(business_name!=""){
            $("#edit_custom_business").hide();
            $("#edit_business_name").prop('disabled', false);
        }
        else{
            $("#edit_business_check").attr('checked', true);
            $("#edit_custom_business").show();
            $("#edit_business_name").prop('disabled', true);
        }

        $("#myEditModal").modal();

    });

    $.validator.addMethod("validDate", function(value, element) {
          var currDate = new Date();
          return Date.parse(currDate) >= Date.parse(value) ||value == "";
    }, "Please enter valid Date");
    $("#bill_form").validate({
        rules: {
            cust_bill: {
                required: true,
            },
            bill_amount: {
                required: true,
            },
            bill_date: {
                required: true,
                validDate: true
            },
            invoice_no:{
                required: true,
            },
        },
        // highlight: function (element) {
        //     $(element).addClass("c1");
        // },
        // unhighlight: function (element) {
        //     $(element).removeClass("c1");
        // },
        messages: {
            cust_bill: {
                required: "Bill is Required",
            },
            bill_amount: {
                required: "Bill Amount is Required",
            },
            bill_date: {
                required: "Bill Date is Required",
            },
            invoice_no: {
                required: "Invoice No. is Required",
            },
        }
    });


    $.validator.addMethod("validDate", function(value, element) {
          var currDate = new Date();
          return Date.parse(currDate) >= Date.parse(value) ||value == "";
    }, "Please enter valid Date");
    
    jQuery.validator.addMethod("dollarsscents", function(value, element) {
        return this.optional(element) || /^\d{0,4}(\.\d{0,2})?$/i.test(value);
    }, "You must include two decimal places");

    jQuery.validator.addMethod("lettersonly", function(value, element) {
    return this.optional(element) || /^[a-z\s]+$/i.test(value);
    }, "Enter only alphabetical characters"); 

    $("#addbilleditform").validate({
        rules: {
            editfile:{
                required: function(element){
                    return $("#editfile_available").val() != 1;
                extension: "jpg|png"
                }
            },
            edit_amount: {
                required: true,
                dollarsscents: true
            },
            edit_date: {
                required: true,
                validDate: true
            },
            edit_invoice_no:{
                required: true,
            },
            edit_custom_business:{
                lettersonly:true,
                maxlength: 25,
            },
            edit_remarks:{
                lettersonly:true,
                maxlength: 30,
            },
            
        },
        highlight: function (element) {
            $(element).addClass("c1");
        },
        unhighlight: function (element) {
            $(element).removeClass("c1");
        },
        messages: {
            editfile: {
                required: "Bill is Required",
                extension: "Only jpg and png file is acceptable."
            },
            edit_amount: {
                required: "Bill Amount is Required",
            },
            edit_date: {
                required: "Bill Date is Required",
            },
            edit_invoice_no:{
                required: "Invoice No. is Required",
            },
        }
    });

     if ( window.history.replaceState ) {
  window.history.replaceState( null, null, window.location.href );
}
    
$(document).ready(function() {

    {% for bill_categories in allocated_bill_categories %}
        
        $('#add-row-{{ forloop.counter }}').DataTable( {
            dom: 'tBfrtip',
            buttons: [    
            ],
        });

    {% endfor %}
});

    $(function() {

        $('.DeleteBillBtn').on('click', function(e) {
          e.preventDefault();
            Swal.fire({
              title: 'Are you sure?',
              icon: 'warning',
              showCancelButton: true,
              confirmButtonColor: '#3085d6',
              cancelButtonColor: '#d33',
              confirmButtonText: 'Yes'
            }).then((result) => {
              if (result.isConfirmed) {
                var id = $(this).attr("data-id");
                var db_table = $(this).attr("data-db_table");
                $.ajax({
                  type: "POST",
                  url: "/delete-my-bills/"+id+"/",
                  data: {csrfmiddlewaretoken: document.getElementsByName('csrfmiddlewaretoken')[0].value, db_table : db_table},
                  success: function(response) {
                      if(response["status"] == "success"){
                        Swal.fire({
                                title:'Deleted!',
                        text:'Bill has been deleted',
                        icon:'success',
                        timer:1500,
                        showConfirmButton:false,
                            })
                        .then(function() {
                        location.reload();
                        });
                      }
                      else if(response["status"] == "error"){
                        Swal.fire({
                        icon:"error",
                        title: "Oops...", 
                        text: "Fail to Delete!", 
                        confirmButtonClass: "btn-success",
                        allowOutsideClick: false,
                        allowEscapeKey: false
                        })
                        .then(function() {
                            location.reload();
                        });   
                      }
                      else{
                        Swal.fire({
                        icon:"error",
                        title: "Oops...", 
                        text: "Something went wrong!", 
                        confirmButtonClass: "btn-success",
                        allowOutsideClick: false,
                        allowEscapeKey: false
                        })
                        .then(function() {
                            location.reload();
                        });   
                      }
                  },
                  error: function() {
                    Swal.fire({
                      icon:"error",
                      title: "Oops...", 
                      text: "Something went wrong!", 
                      confirmButtonClass: "btn-success",
                      allowOutsideClick: false,
                      allowEscapeKey: false
                    })
                      .then(function() {
                        location.reload();
                      });       
                  }
              });
              }
            })
        });
      });


    $(function() {
        $('.DeleteBillBtnNotByCustomer').on('click', function(e) {
          e.preventDefault();
            Swal.fire({
              title: 'Are you sure?',
              icon: 'warning',
              showCancelButton: true,
              confirmButtonColor: '#3085d6',
              cancelButtonColor: '#d33',
              confirmButtonText: 'Yes'
            }).then((result) => {
              if (result.isConfirmed) {
                var id = $(this).attr("data-id");
                var db_table = $(this).attr("data-db_table");
                $.ajax({
                  type: "POST",
                  url: "/delete-merchant-bills/"+id+"/",
                  data: {csrfmiddlewaretoken: document.getElementsByName('csrfmiddlewaretoken')[0].value, db_table : db_table},
                  success: function(response) {
                      if(response["status"] == "success"){
                        Swal.fire({
                                title:'Deleted!',
                        text:'Bill has been deleted',
                        icon:'success',
                        timer:1500,
                        showConfirmButton:false,
                            })
                        .then(function() {
                        location.reload();
                        });
                      }
                      else if(response["status"] == "error"){
                        Swal.fire({
                        icon:"error",
                        title: "Oops...", 
                        text: "Fail to Delete!", 
                        confirmButtonClass: "btn-success",
                        allowOutsideClick: false,
                        allowEscapeKey: false
                        })
                        .then(function() {
                            location.reload();
                        });   
                      }
                      else{
                        Swal.fire({
                        icon:"error",
                        title: "Oops...", 
                        text: "Something went wrong!", 
                        confirmButtonClass: "btn-success",
                        allowOutsideClick: false,
                        allowEscapeKey: false
                        })
                        .then(function() {
                            location.reload();
                        });   
                      }
                  },
                  error: function() {
                    Swal.fire({
                      icon:"error",
                      title: "Oops...", 
                      text: "Something went wrong!", 
                      confirmButtonClass: "btn-success",
                      allowOutsideClick: false,
                      allowEscapeKey: false
                    })
                      .then(function() {
                        location.reload();
                      });       
                  }
              });
              }
            })
        });
      });
</script>

{% endblock content %}

{% block javascripts %}

{% endblock javascripts %} 